package cha.car.controller;

import java.io.File;
import java.io.IOException;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import cha.car.dto.CarDTO;
import cha.car.service.CarService;

@RestController
@RequestMapping("/api")
public class CarApiController {
	@Autowired
	CarService carservice;
	
	// 전체 차량 출력 컨트롤러
	@GetMapping("/")
	public List<CarDTO> getAllCarList(){
		System.out.println("차 컨트롤러 - 차량 전체 출력 컨트롤러");
		return carservice.getAllCar();
	}
	
	// 검색 차량 출력 컨트롤러
	@GetMapping("/searchCar")
	public List<CarDTO> getSearchCarList(
			// 차량 검색 타입(차량 이름, 차량 번호)
//			@RequestBody String searchType,
			// 차량 검색 키워드
//			@RequestBody String searchKeyWord,?
			
			@RequestParam("searchType") String searchType, 
		    @RequestParam("searchKeyWord") String searchKeyWord
			){
		System.out.println("차 컨트롤러 - 검색 차량 출력 컨트롤러");
		
		// 검색 O -> 검색 결과 존재 -> (검색 차량만 출력)
		if(searchType != null && !searchKeyWord.trim().isEmpty()) {
			return carservice.getSearchCar(searchType,searchKeyWord);
		}
		// 검색 X -> 전체 차량 출력
		else {
			return carservice.getAllCar();
		}
		
	}
	
	// 차량 추가 컨트롤러
	@PostMapping("/addCar")
	public boolean addCarList(
			// ★ 파일(이미지)와 dto를 동시에 받아야할 땐 FormData 사용, @RequestBody X 없애야함
			@RequestBody CarDTO cdto, // RequestBody는 post만 가능(dto로 값을 받을 때)
			// 이미지 받기(name이랑 동일해야함)
			@RequestParam("brandLogoImg") MultipartFile brandLogoImg,
			@RequestParam("carImg") MultipartFile carImg
			) throws IllegalStateException, IOException {
		
		System.out.println("차 컨트롤러 - 차량 추가 컨트롤러");
		
		// 01. 이미지 파일을 저장할 실제 하드디스크 위치 지정(webConfig에서 설정한 경로와 일치)
		String savePath = "";
		
		// 02. 해당 폴더가 존재하지 않을 경우 자동생성
		File saveDir = new File(savePath);
		if(!saveDir.exists()) {
			saveDir.mkdir();
		}
		
		// 03. 이미지 업로드 처리
		// 예외처리?
		if(!brandLogoImg.isEmpty()) {
			String originalName = brandLogoImg.getOriginalFilename();
			
			File file = new File(savePath+originalName); // 전체 파일명
			
			// 서버에만 존재하던 파일이 실제 하드디스크에 생성됨
			brandLogoImg.transferTo(file); // 자동으로 throws IllegalStateException, IOException 생김
			
			// DB에 저장
			cdto.setBrandLogo(originalName);
		}
		
		// 이미지까지 들어간 최종 cdto로 DB로 접근
		boolean result = carservice.addCar(cdto);
		return result;
	}
}
